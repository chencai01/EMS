var Y=(I,N,x)=>new Promise((P,L)=>{var C=c=>{try{w(x.next(c))}catch(d){L(d)}},U=c=>{try{w(x.throw(c))}catch(d){L(d)}},w=c=>c.done?P(c.value):Promise.resolve(c.value).then(C,U);w((x=x.apply(I,N)).next())});import{h as M,d as ie,K as ve,r as i,l as me,c as fe,H as _e,a as m,o as v,b as y,f as o,e as n,w as r,g as f,t as u,u as s,F as T,i as z,P as ge,n as A,q as W,y as q,E as h,aL as ye,_ as be}from"./index-BSlF4gO8.js";import{I as Q}from"./index-zPJBks9f.js";import{I as X}from"./icontype-wbc23cyS.js";import{e as Z}from"./mitt-E5P-NQ8u.js";import"./icon-power-off-CJaF8cS6.js";import"./comInterrupt-Cm5Fxwa_.js";const he=I=>M.request("post","/lcmain/upgradeLog",{data:I}),xe=()=>M.request("get","/lcmain?type=upgradePercent"),we={class:"upload"},ke={class:"el-upload__text"},Ve={class:"content"},Le={key:0,class:"circle"},Ce={key:1,class:"circle close"},Ue={class:"log"},Se={class:"flex items-center my-[16px]"},Fe={class:"dark:!text-white"},Be={class:"operator"},Ie={class:"dark:!text-white"},Pe={class:"dark:!text-white"},De={class:"dark:!text-white"},Te={class:"dark:!text-white"},ze={key:0,class:"operator fail"},qe=ie({name:"UploadView",__name:"index",setup(I){const{$axiosCancel:N}=ve(),x=i("1"),P=i("1"),L=[{label:"储能柜#1",enLabel:"Energy Storage Cabinet#1",value:1}],C=i(L[0].value),U=[{label:"ALL",value:-1},{label:"LC",value:1},{label:"BMS",value:2},{label:"BMU",value:3},{label:"WEB",value:4},{label:"PCS",value:5}],w=i(U[0].value),c=i([]),d=i(null),S=i([]),ee=i("YYYY-MM-DD"),_=i(),F=i([]),{locale:$,t:l}=me(),B=i(0),b=i(!1),j=i([]);Z.on("everySecond",t=>{Z.off("everySecond"),S.value=[t.split(" ")[0],t.split(" ")[0]],E()});const ae=fe(()=>{var t;if((t=_.value)!=null&&t.name){const a=_.value.name.indexOf(".");return a>-1?_.value.name.slice(0,a):_.value.name}return"BMS"});_e(()=>{d.value&&(clearInterval(d.value),d.value=null)});const E=()=>Y(this,null,function*(){const t=yield he({deviceType:w.value,startTime:`${S.value[0]} 00:00:00`||"",endTime:`${S.value[1]} 23:59:59`||""});t.code===200&&(j.value=t.data.upgradeLog)}),le=()=>{d.value&&(clearInterval(d.value),d.value=null),B.value=0,c.value=[],d.value=setInterval(()=>Y(this,null,function*(){N("/lcmain?type=upgradePercent"),B.value+=1,B.value>=250&&(clearInterval(d.value),d.value=null,h({type:"error",message:l("upload.upgradeFail")}),b.value=!1);const t=yield xe();t.code===200&&(c.value=(t.data.percent||[]).map(a=>{const p=+a;return p<10?+(B.value*.04).toFixed(2):p})),c.value.every(a=>a>=100)&&(clearInterval(d.value),d.value=null,h({type:"success",message:l("upload.upgradeSuccess")}),b.value=!1)}),200)},te=(t,a,p)=>{},oe=t=>(t==null?void 0:t.size)>1024*1024*1024*1024?(h({type:"error",message:l("upload.uploadFail")}),!1):!0,se=t=>{_.value=t.file;const a=new FormData;return a.append("file",t.file),new Promise((p,k)=>{M.request("post","/lcmain/upload",{headers:{"Content-Type":"multipart/form-data"},data:a,onUploadProgress:g=>{const D=g;D.percent=g.loaded/g.total*100|0,t.onProgress(D)}}).then(g=>{t.onSuccess(g)})}).catch(p=>{t.onError(p)})},ne=(t,a)=>{F.value=a.slice(-1)},ue=()=>{F.value=[],_.value={}},O=(t=0)=>{var a;if(!((a=_.value)!=null&&a.name)){h({type:"warning",message:l("upload.selectUploadFile")});return}b.value=!0,M.request("post","/lcmain/startUpgrade",{data:{name:_.value.name,cabinetNo:C.value,confirm:t}}).then(p=>{if(p.code===200)/^bm/i.test(_.value.name)?le():(c.value=[],h({type:"success",message:l("upload.upgradeSuccess")}),b.value=!1,/^web/i.test(_.value.name)&&window.location.reload());else if(p.code===999){const{confirmFlag:k}=p.data;(k===1||k===2)&&ye.confirm(l(`upload.${k===1?"charge":"discharge"}`),"",{confirmButtonText:l("buttons.confirm"),cancelButtonText:l("buttons.hscancel")}).then(()=>{O(1)}).catch(()=>{b.value=!1})}else p.code===998?(h({type:"warning",message:l("upload.power")}),b.value=!1):(h({type:"error",message:l("upload.upgradeFail")}),b.value=!1)}).catch(()=>{h({type:"error",message:l("upload.upgradeFail")}),b.value=!1})};return(t,a)=>{const p=m("el-option"),k=m("el-select"),g=m("el-icon"),D=m("el-upload"),re=m("el-button"),R=m("Check"),H=m("Close"),de=m("el-progress"),K=m("el-collapse-item"),G=m("el-collapse"),ce=m("el-date-picker");return v(),y("div",we,[o("div",{class:A(["flex items-center",F.value.length?"mb-[30px]":"mb-[16px]"])},[n(k,{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=e=>C.value=e),style:{width:"300px"},class:"mr-[8px] min-w-[155px]"},{prefix:r(()=>[f(u(s(l)("home.energyStorage")),1)]),default:r(()=>[(v(),y(T,null,z(L,(e,V)=>n(p,{key:V,value:e.value,label:s($)==="zh"?e.label:e.enLabel},{default:r(()=>[f(u(s($)==="zh"?e.label:e.enLabel),1)]),_:2},1032,["value","label"])),64))]),_:1},8,["modelValue"]),n(D,{"file-list":F.value,"onUpdate:fileList":a[1]||(a[1]=e=>F.value=e),class:"upload-demo","on-remove":ue,"on-success":te,"before-upload":oe,"http-request":se,onChange:ne},{default:r(()=>[n(g,{class:"el-icon--upload"},{default:r(()=>[n(s(ge))]),_:1}),o("div",ke,u(s(l)("upload.uploadUpgradeFile")),1)]),_:1},8,["file-list"]),n(re,{type:"primary",class:"upload-btn",loading:b.value,onMousedown:a[2]||(a[2]=e=>e.preventDefault()),onClick:a[3]||(a[3]=e=>O(0))},{default:r(()=>[f(u(s(l)("upload.startUpgrade")),1)]),_:1},8,["loading"])],2),c.value.length>0?(v(),W(G,{key:0,modelValue:x.value,"onUpdate:modelValue":a[4]||(a[4]=e=>x.value=e),class:"upload-collapse",accordion:!1},{default:r(()=>[n(K,{name:"1"},{title:r(()=>[n(Q,{label:s(l)("upload.upgradeProgress"),"label-style":{fontWeight:600,fontSize:"14px",color:"#333333",overflow:"visible"},value:"","enable-row":!0,"icon-type":s(X).uploadProgress},null,8,["label","icon-type"])]),default:r(()=>[o("div",Ve,[(v(!0),y(T,null,z(c.value,(e,V)=>(v(),y("div",{key:`${e}-${V}`,class:"content-item"},[o("span",null,u(ae.value),1),n(de,{percentage:e>100?100:e,status:e>=100?"success":""},{default:r(()=>[e>=100?(v(),y("div",Le,[n(g,null,{default:r(()=>[n(R)]),_:1})])):q("",!0),B.value>=250?(v(),y("div",Ce,[n(g,null,{default:r(()=>[n(H)]),_:1})])):q("",!0)]),_:2},1032,["percentage","status"])]))),128))])]),_:1})]),_:1},8,["modelValue"])):q("",!0),n(G,{modelValue:P.value,"onUpdate:modelValue":a[7]||(a[7]=e=>P.value=e),class:"upload-collapse",accordion:!1},{default:r(()=>[n(K,{name:"1"},{title:r(()=>[n(Q,{label:s(l)("upload.upgradeLog"),"label-style":{fontWeight:600,fontSize:"14px",color:"#333333",overflow:"visible"},value:"","enable-row":!0,"icon-type":s(X).uploadLog},null,8,["label","icon-type"])]),default:r(()=>[o("div",Ue,[o("div",Se,[n(k,{modelValue:w.value,"onUpdate:modelValue":a[5]||(a[5]=e=>w.value=e),class:"mr-[8px]",size:"small",style:{width:"300px"},onChange:E},{prefix:r(()=>[f(u(s(l)("query.device_type")),1)]),default:r(()=>[(v(),y(T,null,z(U,(e,V)=>n(p,{key:V,value:e.value,label:e.label},{default:r(()=>[f(u(e.label),1)]),_:2},1032,["value","label"])),64))]),_:1},8,["modelValue"]),n(ce,{modelValue:S.value,"onUpdate:modelValue":a[6]||(a[6]=e=>S.value=e),size:"small",clearable:!1,editable:!1,type:"daterange","range-separator":"~",placeholder:s(l)("date.selectDate"),"start-placeholder":s(l)("date.startDate"),"end-placeholder":s(l)("date.endDate"),class:"!h-[26px]","value-format":ee.value,"suffix-icon":"el-icon-date",onChange:E},null,8,["modelValue","placeholder","start-placeholder","end-placeholder","value-format"])]),(v(!0),y(T,null,z(j.value,(e,V)=>{var J;return v(),y("div",{key:V,class:"log-item"},[o("div",{class:A(["name",{fail:e.state===0}])},[o("span",null,[o("div",{class:A(["circle",{close:e.state===0}])},[n(g,null,{default:r(()=>[e.state?(v(),W(R,{key:0})):(v(),W(H,{key:1}))]),_:2},1024)],2),f(" "+u(e.state?s(l)("upload.upgradeSuccess"):s(l)("upload.upgradeFail")),1)]),o("span",null,u(s($)==="zh"?"储能柜#1":"Energy Storage Cabinet#1"),1),o("span",Fe,u(e.file_name),1)],2),o("div",Be,[o("div",Ie,[o("span",null,u(s(l)("query.device_type")),1),f(" "+u((J=U.find(pe=>pe.value===e.device_type))==null?void 0:J.label),1)]),o("div",Pe,[o("span",null,u(s(l)("upload.upgradeTime")),1),f(" "+u(e.upgrade_time),1)]),o("div",De,[o("span",null,u(s(l)("upload.replyTime")),1),f(" "+u(e.feedback_time),1)]),o("div",Te,[o("span",null,u(s(l)("upload.operator")),1),f(" "+u(e.operator_user),1)])]),e.state===0?(v(),y("div",ze,[o("div",null,[o("span",null,u(s(l)("upload.failReason")),1),f(" "+u(e.failure_cause),1)])])):q("",!0)])}),128))])]),_:1})]),_:1},8,["modelValue"])])}}}),je=be(qe,[["__scopeId","data-v-59e51aef"]]);export{je as default};
