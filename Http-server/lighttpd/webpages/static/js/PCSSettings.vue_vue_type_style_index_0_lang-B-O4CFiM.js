var J=Object.defineProperty,Q=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var B=(d,u,_)=>u in d?J(d,u,{enumerable:!0,configurable:!0,writable:!0,value:_}):d[u]=_,G=(d,u)=>{for(var _ in u||(u={}))Y.call(u,_)&&B(d,_,u[_]);if(R)for(var _ of R(u))Z.call(u,_)&&B(d,_,u[_]);return d},U=(d,u)=>Q(d,X(u));var P=(d,u,_)=>new Promise((k,o)=>{var x=w=>{try{v(_.next(w))}catch(F){o(F)}},g=w=>{try{v(_.throw(w))}catch(F){o(F)}},v=w=>w.done?k(w.value):Promise.resolve(w.value).then(x,g);v((_=_.apply(d,u)).next())});import{u as D}from"./useTimer-DPmIGUt7.js";import{d as I,l as ee,c as te,r as oe,m as re,a as S,o as E,q as V,w as l,e as i,u as s,g as q,t as h,A as M,y as O,n as T,f as A,aU as se,aT as ne,aN as p}from"./index-BSlF4gO8.js";import{v as m}from"./valueUtil-BReNmlgC.js";import{S as ae,P as ie,G as le,a as _e}from"./icon-power-off-CJaF8cS6.js";import{P as y}from"./pcs-NJQvBWG2.js";const ue={class:"flex flex-wrap"},ce={class:"relative",style:{display:"none"}},de=["onClick"],fe={class:"pcs-settings-cell-class-button-name"},pe={class:"pcs-settings-cell-class-button-name"},we={class:"pcs-settings-cell-class-button-name"},he=I({name:"PCSSettings",__name:"PCSSettings",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(d,{emit:u}){const _=d,k=u,{t:o}=ee(),x=te({get:()=>_.modelValue,set:t=>k("update:modelValue",t)}),g=oe([]),v=re({total_active_power_of_AC_bus_input:[{validator:(t,r,n)=>{typeof r=="undefined"||r==null||r.length<=0?n(new Error("请输入有效值！")):n()},trigger:"blur"}],total_reactive_power_of_AC_bus_input:[{validator:(t,r,n)=>{typeof r=="undefined"||r==null||r.length<=0?n(new Error("请输入有效值！")):n()},trigger:"blur"}],total_PF_of_AC_bus_input:[{validator:(t,r,n)=>{setTimeout(()=>{typeof r=="undefined"||r==null||r.length<=0||parseFloat(r)<0||parseFloat(r)>1?n(new Error("应在0～1间！")):n()},700)},trigger:"blur"}]}),w=()=>{let t=null;const r=g.value.some(n=>{const C=n.extra.enableEditMode;return C&&(t=n.extra.saveRef),C});return{saveRef:t,haveEditMode:r}},F=t=>P(this,null,function*(){(t.total_PF_of_AC_bus!=t.extra.total_PF_of_AC_bus_input||t.total_reactive_power_of_AC_bus!=t.extra.total_reactive_power_of_AC_bus_input||t.total_active_power_of_AC_bus!=t.extra.total_active_power_of_AC_bus_input)&&(t.extra.total_PF_of_AC_bus_input=t.total_PF_of_AC_bus,t.extra.total_reactive_power_of_AC_bus_input=t.total_reactive_power_of_AC_bus,t.extra.total_active_power_of_AC_bus_input=t.total_active_power_of_AC_bus),t.extra.enableEditMode=!1;const{haveEditMode:r}=w();r||setTimeout(()=>{x.value=!1},500)}),L=t=>P(this,null,function*(){return N(t,!0)}),N=(t,r=!1)=>P(this,null,function*(){if(!t.extra.enableEditMode){t.extra.enableEditMode=!0;return}const n=t.index+1,C=yield t.extra.total_PF_of_AC_bus_form_ref.validate((e,a)=>e),f=yield t.extra.total_active_power_of_AC_bus_form_ref.validate((e,a)=>e),c=yield t.extra.Total_reactive_power_of_AC_bus_form_ref.validate((e,a)=>e),b=()=>{if(r){const{haveEditMode:e}=w();e||setTimeout(()=>{x.value=!1},500)}};if(C&&f&&c){if(t.total_PF_of_AC_bus==t.extra.total_PF_of_AC_bus_input&&t.total_reactive_power_of_AC_bus==t.extra.total_reactive_power_of_AC_bus_input&&t.total_active_power_of_AC_bus==t.extra.total_active_power_of_AC_bus_input){t.extra.enableEditMode=!1,b();return}y.requestPCSSetSettings(n,+t.extra.total_PF_of_AC_bus_input,+t.extra.total_active_power_of_AC_bus_input,+t.extra.total_reactive_power_of_AC_bus_input).then(e=>{if(e.code==200)t.total_PF_of_AC_bus=+t.extra.total_PF_of_AC_bus_input,t.total_reactive_power_of_AC_bus=+t.extra.total_reactive_power_of_AC_bus_input,t.total_active_power_of_AC_bus=+t.extra.total_active_power_of_AC_bus_input,t.extra.enableEditMode=!1,p(o("pcs.settings.saveSuccess"),{type:"success"}),b();else throw new Error("invalid code")}).catch(e=>{p(o("pcs.settings.saveFailure"),{type:"error"})})}}),z=t=>{const{saveRef:r,haveEditMode:n}=w();n?r==null||r.click():t()},K=(t,r)=>{t?y.requestPCSPowerOn(r).then(n=>{if(n.code==200)p(o("pcs.settings.startupSuccess"),{type:"success"});else throw new Error("invalid code")}).catch(n=>{p(o("pcs.settings.startupFailure"),{type:"error"})}):y.requestPCSPowerOff(r).then(n=>{if(n.code==200)p(o("pcs.settings.shutdownSuccess"),{type:"success"});else throw new Error("invalid code")}).catch(n=>{p(o("pcs.settings.shutdownFailure"),{type:"error"})})},W=(t,r)=>{t?y.requestPCSGridOff(r).then(n=>{if(n.code==200)p(o("pcs.settings.gridOffConnectSuccess"),{type:"success"});else throw new Error("invalid code")}).catch(n=>{p(o("pcs.settings.gridOffConnectFailure"),{type:"error"})}):y.requestPCSGrid(r).then(n=>{if(n.code==200)p(o("pcs.settings.gridConnectSuccess"),{type:"success"});else throw new Error("invalid code")}).catch(n=>{p(o("pcs.settings.gridConnectFailure"),{type:"error"})})},$=t=>{y.requestPCSClearFault(t).then(r=>{if(r.code==200)p(o("pcs.settings.clearFaultSuccess"),{type:"success"});else throw new Error("invalid code")}).catch(r=>{p(o("pcs.settings.clearFaultFailure"),{type:"error"})})},j=()=>P(this,null,function*(){var n,C;let r=(C=(n=(yield y.requestPCSGetSettings()).data)==null?void 0:n.pcsControl)==null?void 0:C.map((f,c)=>U(G({},f),{index:c,extra:null}));r=r.map(f=>{var e,a;const c=g.value.find(H=>H.index==f.index);if(((e=c==null?void 0:c.extra)==null?void 0:e.enableEditMode)==!0)return c;const b=(a=c==null?void 0:c.extra)!=null?a:{total_active_power_of_AC_bus_input:m.roundString(f.total_active_power_of_AC_bus,1),total_reactive_power_of_AC_bus_input:m.roundString(f.total_reactive_power_of_AC_bus,1),total_PF_of_AC_bus_input:m.roundString(f.total_PF_of_AC_bus,2),enableEditMode:!1};return U(G({},f),{extra:b})}),g.value=r});return D(()=>{(!g.value||g.value.length<=0||x.value)&&j()},{immediate:!0,immediateCallback:!0}),(t,r)=>{const n=S("el-table-column"),C=S("el-input"),f=S("el-form-item"),c=S("el-form"),b=S("el-popconfirm");return E(),V(s(ne),{modelValue:x.value,"onUpdate:modelValue":r[0]||(r[0]=e=>x.value=e),class:"pcs-settings-container",size:"79.06%","show-close":!0,"append-to-body":!0,"with-header":!0,title:s(o)("pcs.settings.pcsControl"),direction:"rtl","before-close":z},{default:l(()=>[i(s(se),{data:g.value,"header-cell-class-name":"pcs-settings-header-cell-class-name","row-class-name":"pcs-settings-header-row-class-name"},{default:l(()=>[i(n,{property:"index",label:s(o)("pcs.settings.num"),"min-width":"6%"},{default:l(e=>[q(" #"+h(e.row.index+1),1)]),_:1},8,["label"]),i(n,{property:"onoff_status",label:s(o)("common.workStatus"),"min-width":"11.465%"},{default:l(e=>[e.row.onoff_status==1?(E(),V(M(s(ae)),{key:0,class:"mr-[5px]"})):O("",!0),e.row.onoff_status==0?(E(),V(M(s(ie)),{key:1,class:"mr-[5px]"})):O("",!0),q(" "+h(s(o)(e.row.onoff_status==1?"pcs.settings.startUp":"pcs.settings.shutDown")),1)]),_:1},8,["label"]),i(n,{property:"grid_status",label:s(o)("pcs.settings.gridOffConnectedStatus"),"min-width":"11.8217%"},{default:l(e=>[e.row.grid_status==1?(E(),V(M(s(le)),{key:0,class:"mr-[5px]"})):O("",!0),e.row.grid_status==2?(E(),V(M(s(_e)),{key:1,class:"mr-[5px]"})):O("",!0),q(" "+h(s(o)(e.row.grid_status==1?"pcs.gridConnected":"pcs.offGridConnected")),1)]),_:1},8,["label"]),i(n,{property:"total_active_power_of_AC_bus",label:s(o)("common.activePower")+"（kW）","min-width":"16.2132%"},{default:l(e=>[i(c,{ref:a=>e.row.extra.total_active_power_of_AC_bus_form_ref=a,model:e.row.extra,rules:v},{default:l(()=>[i(f,{prop:"total_active_power_of_AC_bus_input"},{default:l(()=>[i(C,{modelValue:e.row.extra.total_active_power_of_AC_bus_input,"onUpdate:modelValue":a=>e.row.extra.total_active_power_of_AC_bus_input=a,class:T([{"pcs-settings-header-cell-input":!e.row.extra.enableEditMode}]),readonly:!e.row.extra.enableEditMode,placeholder:s(m).roundString(e.row.total_active_power_of_AC_bus,1),formatter:a=>s(m).inputNumberFormat(a,1)},null,8,["modelValue","onUpdate:modelValue","class","readonly","placeholder","formatter"])]),_:2},1024)]),_:2},1032,["model","rules"])]),_:1},8,["label"]),i(n,{property:"total_reactive_power_of_AC_bus",label:s(o)("common.reactivePower")+"（kVar）","min-width":"18.2791%"},{default:l(e=>[i(c,{ref:a=>e.row.extra.Total_reactive_power_of_AC_bus_form_ref=a,model:e.row.extra,rules:v},{default:l(()=>[i(f,{prop:"total_reactive_power_of_AC_bus_input"},{default:l(()=>[i(C,{modelValue:e.row.extra.total_reactive_power_of_AC_bus_input,"onUpdate:modelValue":a=>e.row.extra.total_reactive_power_of_AC_bus_input=a,class:T([{"pcs-settings-header-cell-input":!0}]),readonly:!0,placeholder:s(m).roundString(e.row.total_reactive_power_of_AC_bus,1),formatter:a=>s(m).inputNumberFormat(a,1)},null,8,["modelValue","onUpdate:modelValue","placeholder","formatter"])]),_:2},1024)]),_:2},1032,["model","rules"])]),_:1},8,["label"]),i(n,{property:"total_PF_of_AC_bus",label:s(o)("pcs.settings.powerFactor"),"min-width":"11.6318%"},{default:l(e=>[i(c,{ref:a=>e.row.extra.total_PF_of_AC_bus_form_ref=a,model:e.row.extra,rules:v},{default:l(()=>[i(f,{prop:"total_PF_of_AC_bus_input"},{default:l(()=>[i(C,{modelValue:e.row.extra.total_PF_of_AC_bus_input,"onUpdate:modelValue":a=>e.row.extra.total_PF_of_AC_bus_input=a,class:T([{"pcs-settings-header-cell-input":!0}]),readonly:!0,placeholder:s(m).roundString(e.row.total_PF_of_AC_bus,2),formatter:a=>s(m).inputNumberFormat(a,2)},null,8,["modelValue","onUpdate:modelValue","placeholder","formatter"])]),_:2},1024)]),_:2},1032,["model","rules"])]),_:1},8,["label"]),i(n,{property:"operation",label:s(o)("pcs.settings.operation"),"min-width":"22.3178%"},{default:l(e=>[A("div",ue,[A("div",ce,[i(b,{width:"200px",placement:"top","confirm-button-text":s(o)("pcs.settings.yes"),"cancel-button-text":s(o)("pcs.settings.no"),title:s(o)("pcs.settings.popConfirmTitle"),"hide-icon":!0,onConfirm:()=>L(e.row),onCancel:()=>F(e.row)},{reference:l(()=>[A("div",{ref:a=>e.row.extra.saveRef=a,style:{color:"transparent !important",height:"1px",width:"1px",position:"absolute",left:"0",top:"0",margin:"auto",right:"0"}},null,512)]),_:2},1032,["confirm-button-text","cancel-button-text","title","onConfirm","onCancel"]),A("div",{class:T(["pcs-settings-cell-class-button-name",{"pcs-settings-cell-class-button-name-edit":!e.row.extra.enableEditMode}]),onClick:()=>N(e.row)},h(e.row.extra.enableEditMode?s(o)("pcs.settings.save"):s(o)("pcs.settings.edit")),11,de)]),i(b,{width:"200px",placement:"top","confirm-button-text":s(o)("pcs.settings.yes"),"cancel-button-text":s(o)("pcs.settings.no"),title:s(o)(e.row.onoff_status==0?"pcs.settings.popConfirmTitleStartUp":"pcs.settings.popConfirmTitleShutDown"),"hide-icon":!0,onConfirm:()=>K(e.row.onoff_status==0,e.row.index+1)},{reference:l(()=>[A("div",fe,h(s(o)(e.row.onoff_status==0?"pcs.settings.startUp":"pcs.settings.shutDown")),1)]),_:2},1032,["confirm-button-text","cancel-button-text","title","onConfirm"]),i(b,{width:"200px",placement:"top","confirm-button-text":s(o)("pcs.settings.yes"),"cancel-button-text":s(o)("pcs.settings.no"),title:s(o)(e.row.grid_status==1?"pcs.settings.popConfirmTitleOffGridConnected":"pcs.settings.popConfirmTitleGridConnected"),"hide-icon":!0,onConfirm:()=>W(e.row.grid_status==1,e.row.index+1)},{reference:l(()=>[A("div",pe,h(s(o)(e.row.grid_status==1?"pcs.settings.gridOffConnect":"pcs.settings.gridConnect")),1)]),_:2},1032,["confirm-button-text","cancel-button-text","title","onConfirm"]),i(b,{width:"200px",placement:"top","confirm-button-text":s(o)("pcs.settings.yes"),"cancel-button-text":s(o)("pcs.settings.no"),title:s(o)("pcs.settings.popConfirmTitleClearFault"),"hide-icon":!0,onConfirm:()=>$(e.row.index+1)},{reference:l(()=>[A("div",we,h(s(o)("pcs.settings.clearFault")),1)]),_:2},1032,["confirm-button-text","cancel-button-text","title","onConfirm"])])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"])}}});export{he as _};
